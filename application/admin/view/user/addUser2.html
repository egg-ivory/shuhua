<!-- 头部 -->
{include file="public/head"/}
<!-- 引入侧边栏菜单 -->
{include file="public/sidebar"/}

<!-- 引入顶部导航 -->
{include file="public/top_nav"/}
 <!--内容开始-->
<div class="right_col" role="main">

    <div class="col-md-12 col-sm-12 col-xs-12 ">
        <div class="this_location"><a href="/admin">主页</a> > <a href="{:url('/admin/user/addUser')}">添加用户</a></div>
         <div class="x_panel">
            <div class="layui-tab layui-tab-brief" lay-filter="user-tab">
                <ul class="layui-tab-title">
                    <li class="layui-this">用户信息</li>
                </ul>
                <div class="layui-tab-content mt-20">
                    <div class="layui-tab-item layui-show layui-col-md12">
                        <form class="layui-form" method="post" action="" id ='add-user' lay-filter="form1" autocomplete="off" >
                            <div class="layui-form-item ">
                                <label class="layui-form-label">姓名</label>
                                <div class="layui-input-block">
                                    <input type="text" name="name" required  lay-verify="required" placeholder="请输入姓名" autocomplete="off" class="layui-input" value="test">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">性别</label>
                                <div class="layui-input-block">
                                    <input type="radio" name="gender" value=1 title="男">
                                    <input type="radio" name="gender" value=0 title="女" >
                                    <input type="radio" name="gender" value=2 title="未知" checked>
                                </div>
                            </div>
                            <div class="layui-form-item ">
                                <label class="layui-form-label">手机号码</label>
                                <div class="layui-input-inline">
                                    <input type="text" name="phone" required lay-verify="phone"  placeholder="请输入手机号码" autocomplete="off" class="layui-input" value="13800138000">
                                </div>
                                <div class="layui-form-mid layui-word-aux">可作为登录账号</div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">密码</label>
                                <div class="layui-input-inline">
                                    <input type="password" name="mid" required lay-verify="required|pass" placeholder="请输入密码" autocomplete="off" class="layui-input" value="123456">
                                </div>
                                <div class="layui-form-mid layui-word-aux">密码必须6到12位，且不能出现空格</div>
                            </div>
            
                            <div class="layui-form-item ">
                                <label class="layui-form-label">身份证号</label>
                                <div class="layui-input-block">
                                    <input type="text" name="id_card" lay-verify="idCard"  placeholder="请输入身份证号" autocomplete="off" class="layui-input">
                                </div>
                            </div>
            
                            <div class="layui-form-item">
                                <label class="layui-form-label">地址</label>
                                <div class="layui-input-block">
                                    <input type="text" name="address" autocomplete="off" class="layui-input" placeholder="请输入地址" >
                                </div>
                            </div>
            
                            <div class="layui-form-item">
                                <label class="layui-form-label">状态</label>
                                <div class="layui-input-block">
                                    <input type="radio" name="status" title="正常" value="1" checked>
                                    <input type="radio" name="status" title="禁用" value="0">
                                </div>
                            </div>
            
                            <div class="layui-form-item layui-form-text">
                                <label class="layui-form-label">描述</label>
                                <div class="layui-input-block">
                                    <textarea name="description" lay-verify='description' placeholder="最多240个字符" class="layui-textarea"></textarea>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <div class="layui-input-block">
                                    <button class="layui-btn" lay-submit="" lay-filter="submit">提交</button>
                                    <!-- <button type="button" class="layui-btn" onclick="confirmSubmit('add-user');">提交</button> -->
                                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                                </div>
                            </div>
            
                            <input type="hidden" name="actionType" value="add">
                        </form>
                    </div>
            
                </div>
            
            </div>
        </div> 
       
    </div>

</div>

<!--车辆信息-->
<script type="text/html" id="add-car-tab">
    <form class="layui-form" method="post" action="" id ='add-user-car' autocomplete="off">

        <div class="layui-form-item layui-hide">
            <label class="layui-form-label">姓名</label>
            <div class="layui-input-block">
                <input type="text" name="user_name" required  lay-verify="" placeholder="用户姓名" autocomplete="off" class="layui-input" id="user-name" readonly="true">
            </div>
        </div>

        <div class="layui-form-item layui-hide">
            <label class="layui-form-label">用户id</label>
            <div class="layui-input-block">
                <input type="text" name="user_id" required  lay-verify="" placeholder="用户id" autocomplete="off" class="layui-input" id="user-id"  readonly="true" >
            </div>
        </div>
        <style>
            .layui-form-select{
                width:100%;
            }
        </style>
        <div class="layui-form-item">
            <label class="layui-form-label">车辆品牌</label>
            <div class="layui-input-inline">
                <select name="brand_id" id="car-brand" lay-verify="required" lay-filter="car-brand" lay-search>
                    <option value="">选择品牌</option>
                    {volist name = 'car_brand' id = 'v'}
                    <option value="{$v['brand_id']}">{$v['brand_name']}</option>
                    {/volist}
                </select>
            </div>
            <label class="layui-form-label">车辆款式</label>
            <div class="layui-input-inline">
                <select name="style" id="car-style" lay-verify="required" lay-filter="car-style" lay-search>
                    <option value="">选择款式</option>
                </select>
            </div>
            <label class="layui-form-label">车辆名称</label>
            <div class="layui-input-inline">
                <select name="name" id="car-name" lay-verify="required" lay-filter="car-name" lay-search>
                    <option value="">选择名称</option>
                </select>
            </div>
        </div>


        <!-- <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">描述</label>
            <div class="layui-input-block">
                <textarea name="description" placeholder="请输入内容" lay-verify="description" class="layui-textarea"></textarea>
            </div>
        </div> -->
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit="" lay-filter="submit1">提交</button>
                <!--<button type="button" class="layui-btn" onclick="confirmSubmit1('add-user-car');">提交</button>-->
                <!--<button type="reset" class="layui-btn layui-btn-primary">重置</button>-->
            </div>
        </div>

        <input type="hidden" name="actionType" value="add">
    </form>
 </script>

<!--添加用户保险部分-->
<script type="text/html" id="add-insurance-tab">
    <form class="layui-form" method="post" action="" id ='add-user-insurance' >

        <div class="layui-form-item ">
            <label class="layui-form-label">姓名</label>
            <div class="layui-input-block">
                <input type="text" name="user_name" required  lay-verify="required" placeholder="用户姓名" autocomplete="off" class="layui-input" id="user-name-insurance" readonly="true">
            </div>
        </div>

        <div class="layui-form-item hidden">
            <label class="layui-form-label">用户id</label>
            <div class="layui-input-block">
                <input type="text" name="user_id" required  lay-verify="required" placeholder="用户id" autocomplete="off" class="layui-input" id="user-id-insurance"  readonly="true" >
            </div>
        </div>

        <div class="layui-form-item hidden">
            <label class="layui-form-label">用户车辆ID</label>
            <div class="layui-input-block">
                <input type="text" name="uc_id" required  lay-verify="required" placeholder="用户车辆ID" autocomplete="off" class="layui-input" id="uc_id-insurance"  readonly="true" >
            </div>

        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">车辆品牌</label>
            <div class="layui-input-block">
                <input type="text" name="brand" required  lay-verify="required" placeholder="车辆品牌" autocomplete="off" class="layui-input" id="car-brand-insurance"  readonly="true" >
            </div>

        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">车辆名称</label>

            <div class="layui-input-block">
                <input type="text" name="name" required  lay-verify="required" placeholder="车辆品牌" autocomplete="off" class="layui-input" id="car-name-insurance"  readonly="true" >
            </div>

        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">车辆款式</label>
            <div class="layui-input-block">
                <input type="text" name="style" required  lay-verify="required" placeholder="车辆款式" autocomplete="off" class="layui-input" id="car-style-insurance"  readonly="true" >
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">保险公司</label>
            <div class="layui-input-block">
                <input type="text" name="company" required  lay-verify="required" placeholder="保险公司" autocomplete="off" class="layui-input" id="car-company-insurance"   >
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">保险城市</label>
            <div class="layui-input-block">
                <input type="text" name="city" required  lay-verify="required" placeholder="保险城市" autocomplete="off" class="layui-input" id="car-city-insurance"   >
            </div>
        </div>

        <!--<div class="layui-form-item">-->
            <!--<label class="layui-form-label">投保日期</label>-->
            <!--<div class="layui-input-block">-->
                <!--<input type="text" name="time" required  lay-verify="" placeholder="投保日期" autocomplete="off" class="layui-input" id="car-time-insurance"   >-->
            <!--</div>-->
        <!--</div>-->

        <div class="layui-form-item">
            <label class="layui-form-label">投保年限</label>
            <div class="layui-input-block">
                <input type="text" name="years" required  lay-verify="required" placeholder="投保年限" autocomplete="off" class="layui-input" id="car-years-insurance"   >
            </div>
        </div>


        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">描述</label>
            <div class="layui-input-block">
                <textarea name="description" placeholder="请输入内容" class="layui-textarea"></textarea>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit="" lay-filter="submit2">提交</button>
                <!--<button type="button" class="layui-btn" onclick="confirmSubmit2('add-user-insurance');">提交</button>-->
                <!--<button type="reset" class="layui-btn layui-btn-primary">重置</button>-->
            </div>
        </div>

        <input type="hidden" name="actionType" value="add">
    </form>
</script>

<!--添加用户车贷部分-->
<script type="text/html" id="add-payment-tab">
    <form class="layui-form" method="post" action="" id ='add-user-payment' >

        <div class="layui-form-item ">
            <label class="layui-form-label">姓名</label>
            <div class="layui-input-block">
                <input type="text" name="user_name" required  lay-verify="required" placeholder="用户姓名" autocomplete="off" class="layui-input" id="user-name-payment" readonly="true">
            </div>
        </div>

        <div class="layui-form-item ">
            <label class="layui-form-label">用户id</label>
            <div class="layui-input-block">
                <input type="text" name="user_id" required  lay-verify="required" placeholder="用户id" autocomplete="off" class="layui-input" id="user-id-payment"  readonly="true" >
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">用户车辆ID</label>
            <div class="layui-input-block">
                <input type="text" name="uc_id" required  lay-verify="required" placeholder="用户车辆ID" autocomplete="off" class="layui-input" id="uc_id-payment"  readonly="true" >
            </div>

        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">车辆品牌</label>
            <div class="layui-input-block">
                <input type="text" name="brand" required  lay-verify="required" placeholder="车辆品牌" autocomplete="off" class="layui-input" id="car-brand-payment"  readonly="true" >
            </div>

        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">车辆名称</label>

            <div class="layui-input-block">
                <input type="text" name="name" required  lay-verify="required" placeholder="车辆品牌" autocomplete="off" class="layui-input" id="car-name-payment"  readonly="true" >
            </div>

        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">车辆款式</label>
            <div class="layui-input-block">
                <input type="text" name="style" required  lay-verify="required" placeholder="车辆款式" autocomplete="off" class="layui-input" id="car-style-payment"  readonly="true" >
            </div>
        </div>




        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">描述</label>
            <div class="layui-input-block">
                <textarea name="desc" placeholder="请输入内容" class="layui-textarea"></textarea>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit="" lay-filter="submit3">提交</button>
                <button type="button" class="layui-btn" onclick="confirmSubmit3('add-user-payment');">提交</button>
                <!--<button type="reset" class="layui-btn layui-btn-primary">重置</button>-->
            </div>
        </div>

        <input type="hidden" name="actionType" value="add">
    </form>
</script>
<!-- 引入底部 -->
{include file="public/footer"/}
<script>
    var lastUserId='';
    var lastUserName='';
    var lastCarId='';
    var lastCarBrand='';
    var lastCarName='';
    var lastCarStyle='';
    var lastUcId='';
    layui.use(['form','element'], function(){
        var element = layui.element;
        var form = layui.form;
        // 车辆信息
        form.on('select(car-brand)', function(data){
            lastCarBrand = data.value,
            style = "",
            data = {'brand_id':lastCarBrand};
            $.ajax({
                url:'/admin/car/findCarInfo',
                data:data,
                success:function (res) {
                    var style_data = res.style_data;
                    var data = res.data;
                    var content='<option value="">选择款式</option>';
                    for(j=0;j < style_data.length;j++){
                        content=content+' <option value='+style_data[j]['style']+'>'+style_data[j]['style_name']+'</option>'
                    }
                    $('#car-style').html(content.toString());
                    form.render('select');

                }
            });
        });
        form.on('select(car-style)', function(data){
            lastCarStyle=data.value;
            data = {'style':lastCarStyle,'brand_id':lastCarBrand};
            $.ajax({
                url:'/admin/car/findCarInfo',
                data:data,
                success:function (data) {
                    data=data.data;
                    console.log(data);
                    var content='<option value="">选择名称</option>';
                    var length = data.length;
                    for(j=0;j < length;j++){
                        content=content+' <option value='+data[j].car_id+'>'+data[j].name+'</option>'
                    }

                    $('#car-name').html(content.toString());
                    form.render('select');

                }
            });

        });
        /*form.on('select(car-style)',function (data) {
            lastCarStyle=data.value;
            data={'name':lastCarName,'brand':lastCarBrand,'style':lastCarStyle};
            $.ajax({
                url:'/admin/car/findCarInfo',
                data:data,
                success:function (data) {
                    data=data.data;
                    lastCarId=data[0].car_id;
                    //console.log(lastCarId);


                    // var content='<option value="">选择款式</option>';
                    // var length = data.length;
                    // for(j=0;j < length;j++){
                    //     content=content+' <option value='+data[j].style+'>'+data[j].style+'</option>'
                    // }
                    
                    // $('#car-style').html(content.toString());
                    // form.render('select');


                }
            })

        })*/

        // 增加用户
        form.on('submit(submit)', function(data){

            if (data.field.status===undefined || data.field.status!='1'){
                data.field.status=0;
            }
            var data1=data.field;
            layer.open({
                title : '提示',
                icon:3,
                content : '确定要提交吗？',
                btn : ['确定', '取消'],
                yes  : function (index, layero){
                    layer.close(index);
                    layer.msg("添加用户信息成功，请添加车辆信息");
                    var title2 = document.getElementById('add-car-tab').innerHTML;
                    element.tabAdd('user-tab', {
                        title: '车辆信息'
                        , content: title2 //支持传入html
                        , id: 'add-car-content'
                    });

                    element.tabChange('user-tab', 'add-car-content');
                    form.render();
                    /*$.ajax({
                        url:'/admin/user/addUser',
                        type:'post',
                        data:data1,
                        success:function (data) {
                            //console.log(data);

                            if (data.resultCD == 200){
                                layer.msg("添加用户信息成功，请添加车辆信息");
                                lastUserId=data.data.user_id;
                                lastUserName=data.data.name;

                                var element = layui.element;
                                var form = layui.form;
                                if (!$("[lay-id='add-car-content']")[0]) {
                                    var title2 = document.getElementById('add-car-tab').innerHTML;

                                    element.tabAdd('user-tab', {
                                        title: '车辆信息'
                                        , content: title2 //支持传入html
                                        , id: 'add-car-content'
                                    });
                                    element.tabChange('user-tab', 'add-car-content');
                                }
                                if ($("[lay-id='add-insurance']")[0]){
                                    element.tabDelete('user-tab','add-insurance')
                                }
                                if ($("[lay-id='add-payment']")[0]){
                                    element.tabDelete('user-tab','add-payment')
                                }
                                $('#user-name').val(lastUserName);
                                $('#user-id').val(lastUserId);
                                form.render();
                            }else {
                                layer.msg(data.errorMsg)
                            }
                        }
                    });*/
                    //$("#"+obj)[0].reset();
                }
            });
            return false;
        });

        //增加车辆
        form.on('submit(submit1)', function(data){

            layer.open({
                title : '提示',
                icon:3,
                content : '确定要提交吗？',
                btn : ['确定', '取消'],
                yes  : function (index, layero){
                    layer.close(index);
                    $("#add-user-car").ajaxSubmit({
                        url:'/admin/user_car/addUserCar',
                        type:'post',

                        success:function (data) {

                            if (data.resultCD == 200){
                                data=data.data;
                                lastCarId=data.car_id;
                                lastUcId=data.uc_id;
                                lastUserId=data.user_id;


                                layer.msg("用户车辆添加成功,可继续添加用户车贷")

                                var element = layui.element;
                                var form = layui.form;
                                if (!$("[lay-id='add-insurance']")[0]) {
                                    var title3 = document.getElementById('add-insurance-tab').innerHTML;


                                    element.tabAdd('user-tab', {
                                        title: '添加保险'
                                        // ,content:'njkkjoh'
                                        , content: title3 //支持传入html
                                        , id: 'add-insurance'
                                    });

                                }
                                if (!$("[lay-id='add-payment']")[0]) {
                                    var title4 = document.getElementById('add-payment-tab').innerHTML;

                                    element.tabAdd('user-tab', {
                                        title: '添加车贷'
                                        , content: title4 //支持传入html
                                        , id: 'add-payment'
                                    });

                                }

                                //绑定页面数据
                                $("#user-name-insurance").val(lastUserName);
                                $('#user-id-insurance').val(lastUserId);
                                $('#uc_id-insurance').val(lastUcId);
                                $('#car-brand-insurance').val(lastCarBrand);
                                $('#car-name-insurance').val(lastCarName);
                                $('#car-style-insurance').val(lastCarStyle);

                                //绑定payment页面数据

                                $('#user-name-payment').val(lastUserName);
                                $('#user-id-payment').val(lastUserId);
                                $('#uc_id-payment').val(lastUcId);
                                $('#car-brand-payment').val(lastCarBrand);
                                $('#car-name-payment').val(lastCarName);
                                $('#car-style-payment').val(lastCarStyle);


                                form.render();

                            }else {
                                layer.msg('添加失败，'+data.errorMsg)
                            }
                        }});
                    // $("#"+obj)[0].reset();
                }
            });
            return false;
        });

        //增加保险
        form.on('submit(submit2)', function(data){
            // if (data.field.time==''){
            //     delete data.field.time;
            // }

            layer.open({
                title : '提示',
                content : '确定要提交吗？',
                btn : ['确定', '取消'],
                yes  : function (index, layero){
                    layer.close(index);
                    $("#add-user-insurance").ajaxSubmit({
                        url:'/admin/insurance/addInsurance',
                        type:'post',
                        success:function (data) {

                            if (data.resultCD == 200){
                                data=data.data;
                                lastCarId=data.car_id;
                                lastUcId=data.uc_id;
                                lastUserId=data.user_id;
                                layer.msg("保险添加成功")

                                if ($("[lay-id='add-insurance']")[0]){
                                    element.tabDelete('user-tab','add-insurance')
                                }

                                // var element = layui.element;
                                // var form = layui.form;
                                // if (!$("[lay-id='add-insurance']")[0]) {
                                //     var title3 = document.getElementById('add-insurance-tab').innerHTML;
                                //
                                //
                                //     element.tabAdd('user-tab', {
                                //         title: '添加保险'
                                //         // ,content:'njkkjoh'
                                //         , content: title3 //支持传入html
                                //         , id: 'add-insurance'
                                //     });
                                //
                                // }
                                // if (!$("[lay-id='add-payment']")[0]) {
                                //     var title4 = document.getElementById('add-insurance-tab').innerHTML;
                                //
                                //     element.tabAdd('user-tab', {
                                //         title: '添加车贷'
                                //         , content: title4 //支持传入html
                                //         , id: 'add-payment'
                                //     });
                                //
                                // }
                                // $('#user-name-insurance').val(lastUserName);
                                // $('#user-id-payment').val(lastUserId);
                                // form.render();

                            }else {
                                layer.msg(data.errorMsg)
                            }
                        }});
                    // $("#"+obj)[0].reset();
                }
            });
            return false;
        });

        //增加车贷
        form.on('submit(submit3)', function(data){



            layer.open({
                title : '提示',
                content : '确定要提交吗？',
                btn : ['确定', '取消'],
                yes  : function (index, layero){
                    layer.close(index);
                    $("#add-user-payment").ajaxSubmit({
                        url:'/admin/payment/addPayment',
                        type:'post',
                        success:function (data) {

                            if (data.resultCD == 200){
                                data=data.data;
                                lastCarId=data.car_id;
                                lastUcId=data.uc_id;
                                lastUserId=data.user_id;
                                layer.msg("车贷添加成功")

                                if ($("[lay-id='add-payment']")[0]){
                                    element.tabDelete('user-tab','add-payment')
                                }
                            }else {
                                layer.msg(data.errorMsg)
                            }
                        }});
                    // $("#"+obj)[0].reset();
                }
            });
            return false;
        });

        //表单验证
        form.verify({
            pass:[
                /^[\S]{6,12}$/
                ,'密码必须6到12位，且不能出现空格'
            ],
            idCard:function (value, item) {
                if(value!=''&&(!(/^[1-9]\d{7}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}$/.test(value)) && !(/^[1-9]\d{5}[1-9]\d{3}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}([0-9]|X)$/.test(value)))){
                    return '请输入正确身份证格式或不填';
                }
            },
            description:function (value, item) {
                if(value.length > 240){
                    return '最多只能输入240个字符'
                }
            }
        });



    });
</script>




















